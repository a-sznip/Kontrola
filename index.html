<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Zarządzania Kontrolami</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .participant-checkbox {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            border-radius: 0.25rem;
            position: relative;
            cursor: pointer;
            outline: none;
        }
        .participant-checkbox:checked {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .participant-checkbox:checked::before {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.875rem;
        }
        .signature-pad {
            border: 2px solid #3b82f6;
            background-color: #fff;
            cursor: crosshair;
            touch-action: none;
            height: 12rem; /* Zmieniono z h-32 na h-48 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Panel Zarządzania Kontrolami</h1>
        
        <div id="main-list-view">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
                <input type="text" id="filter-address" placeholder="Filtruj po adresie..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="filter-type" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Wszystkie typy</option>
                    <option value="planowa">Planowa</option>
                    <option value="interwencyjna">Interwencyjna</option>
                </select>
                <button id="add-control-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">Dodaj kontrolę</button>
                <button id="clear-all-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">Wyczyść wszystkie</button>
            </div>
            
            <div id="controls-list" class="space-y-4">
                </div>
        </div>

        <div id="route-list-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Trasówka</h2>
            <div class="flex items-center space-x-4 mb-6">
                <label for="route-date" class="font-medium text-gray-700">Wybierz datę trasówki:</label>
                <input type="date" id="route-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="generate-route-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">Generuj trasówkę</button>
                <button id="show-main-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">Powrót</button>
            </div>
            <div id="route-content" class="bg-gray-100 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Trasa na dzień <span id="route-date-display"></span></h3>
                <ul id="route-items" class="space-y-3">
                    </ul>
            </div>
            <button id="download-route-btn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 w-full hidden">Pobierz trasówkę (PDF)</button>
        </div>

        <div id="message-box" class="fixed bottom-8 right-8 p-4 rounded-lg text-white shadow-lg z-50 transition-opacity duration-300 opacity-0 hidden"></div>
    </div>

    <div id="control-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Dodaj nową kontrolę</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            </div>
            <form id="control-form" class="space-y-4">
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                    <div class="flex-1">
                        <label for="control-street" class="block text-gray-700 font-medium mb-1">Ulica</label>
                        <input type="text" id="control-street" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex-1">
                        <label for="control-house-number" class="block text-gray-700 font-medium mb-1">Numer domu</label>
                        <input type="text" id="control-house-number" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                    <div class="flex-1">
                        <label for="control-city" class="block text-gray-700 font-medium mb-1">Miejscowość</label>
                        <input type="text" id="control-city" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex-1">
                        <label for="control-zip" class="block text-gray-700 font-medium mb-1">Kod pocztowy</label>
                        <input type="text" id="control-zip" required pattern="[0-9]{2}-[0-9]{3}" placeholder="np. 12-345" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label for="control-type" class="block text-gray-700 font-medium mb-1">Typ</label>
                    <select id="control-type" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="planowa">Planowa</option>
                        <option value="interwencyjna">Interwencyjna</option>
                    </select>
                </div>
                <div>
                    <label for="control-date" class="block text-gray-700 font-medium mb-1">Data</label>
                    <input type="date" id="control-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="space-y-2">
                    <label class="block text-gray-700 font-medium">Uczestnicy</label>
                    <div id="participants-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        </div>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 flex-1">Zapisz</button>
                    <button type="button" id="delete-control-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 flex-1 hidden">Usuń</button>
                    <button type="button" id="generate-protocol-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 flex-1 hidden">Generuj protokół</button>
                </div>
            </form>
        </div>
    </div>

    <div id="protocol-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 invisible">
        <div class="modal-content bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Generowanie Protokołu Oględzin</h2>
                <button id="close-protocol-modal-btn" class="text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
            </div>
            <form id="protocol-form" class="space-y-4">
                <div>
                    <label for="protocol-date" class="block text-gray-700 font-medium mb-1">Data oględzin</label>
                    <input type="date" id="protocol-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="protocol-case" class="block text-gray-700 font-medium mb-1">Sprawa</label>
                    <textarea id="protocol-case" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-gray-700 font-medium">Obecni</label>
                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                        <div class="flex-1">
                            <label for="protocol-union-reps" class="block text-gray-700 mb-1">Przedstawiciele Związku</label>
                            <textarea id="protocol-union-reps" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="mt-2 text-sm text-gray-500">Automatycznie uzupełnione z danych kontroli.</div>
                        </div>
                        <div class="flex-1">
                            <label for="protocol-admin-reps" class="block text-gray-700 mb-1">Inni przedstawiciele organów administracji</label>
                            <textarea id="protocol-admin-reps" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="protocol-parties" class="block text-gray-700 font-medium mb-1">Strony i ich pełnomocnicy</label>
                    <textarea id="protocol-parties" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label for="protocol-witnesses" class="block text-gray-700 font-medium mb-1">Świadkowie</label>
                    <textarea id="protocol-witnesses" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="note-selection-container p-4 bg-gray-100 rounded-lg">
                    <label class="block text-gray-700 font-medium mb-2">Dodaj notatki</label>
                    <div id="note-categories" class="flex flex-wrap gap-2 mb-2"></div>
                    <div id="note-list" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <label for="protocol-findings" class="block text-gray-700 font-medium mb-1">Ustalono co następuje</label>
                    <textarea id="protocol-findings" rows="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="space-y-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <label class="block text-gray-700 font-medium mb-1">Dodaj zdjęcia z aparatu / pliku</label>
                    <input type="file" id="protocol-photos-input" accept="image/*" multiple capture="environment" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <div id="photos-preview-container" class="mt-4 flex flex-wrap gap-3">
                        </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Podpis przedstawicieli Związku</label>
                        <canvas id="union-signature-pad" class="signature-pad w-full h-48"></canvas>
                        <button type="button" id="clear-union-signature" class="mt-1 text-sm text-gray-500 hover:text-gray-700">Wyczyść podpis</button>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-1">Podpis stron i osób obecnych</label>
                        <canvas id="parties-signature-pad" class="signature-pad w-full h-48"></canvas>
                        <button type="button" id="clear-parties-signature" class="mt-1 text-sm text-gray-500 hover:text-gray-700">Wyczyść podpis</button>
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button type="button" id="save-protocol-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 flex-1">Zapisz protokół</button>
                    <button type="button" id="finalize-protocol-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 flex-1">Generuj i pobierz protokół</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pdf-content-container" class="absolute -left-[9999px] p-6 bg-white w-[794px] h-[1123px] font-sans">
        </div>
    
    <script>
        // Dane pobrane z plików CSV/ODS i wbudowane w kod
        const ulice = ["Jana Pawła II", "Kościuszki", "Sienkiewicza", "Piłsudskiego", "Mickiewicza", "Chopina", "Długa", "Krótka", "Słowackiego", "Grunwaldzka", "Leśna", "Polna", "Szkolna", "Kościelna", "Kwiatowa", "Ogrodowa", "Parkowa", "Sportowa", "Wesoła", "Lipowa", "Akacjowa", "Klonowa", "Brzozowa", "Różana", "Spokojna", "Słoneczna", "Wąska", "Stawowa", "Cicha", "Wiosenna", "Letnia", "Jesienna", "Zimowa", "Orzechowa", "Kasztanowa", "Grabowa", "Bukowa", "Świerkowa", "Sosnowa", "Jodłowa", "Modrzewiowa", "Dębowa", "Topolowa", "Wiązowa", "Cisowa", "Jaworowa", "Świerkowa", "Jaśminowa", "Konwaliowa", "Magnoliowa", "Lawendowa", "Chabrowa", "Fiołkowa", "Bławatkowa", "Bratkowa", "Dalii", "Nasturcjowa", "Storczykowa", "Makowa", "Liliowa", "Krokusowa", "Narcyzowa", "Tulipanowa", "Żonkilowa", "Frezjowa", "Hiacyntowa", "Geraniowa", "Jaskrowa", "Pierwiosnkowa", "Lazurowa", "Błękitna", "Granatowa", "Szafirowa", "Bursztynowa", "Perłowa", "Koralowa", "Diamentowa", "Złota", "Srebrna", "Platynowa", "Miedziana", "Żelazna", "Stalowa", "Brązowa", "Granitowa", "Bazaltowa", "Wapienna", "Piaskowa", "Skalista", "Kamienna", "Jaskiniowa", "Wulkaniczna", "Polarna", "Arktyczna", "Antarktyczna", "Północna", "Południowa", "Wschodnia", "Zachodnia", "Centralna", "Główna", "Rynek", "Plac Wolności", "Plac Zwycięstwa", "Plac Konstytucji", "Plac Bohaterów", "Plac Piastowski", "Plac Zamkowy", "Plac Kościelny", "Plac Targowy", "Plac Szkolny", "Boczna", "Równa", "Prosta", "Krzywa", "Wesoła", "Pogodna", "Spokojna", "Radosna", "Przyjazna", "Uprzejma", "Grzeczna", "Szczęśliwa", "Pomyślna", "Tęczowa", "Gwiezdna", "Księżycowa", "Planetarna", "Droga Mleczna", "Kosmiczna", "Słoneczna", "Jowisza", "Marsa", "Wenus", "Saturna", "Urana", "Neptuna", "Plutona", "Ziemi", "Księżyca", "Komety", "Asteroidy", "Drogi", "Aleja", "Rondo", "Plac", "Bulwar", "Skwer", "Zaułek", "Zawiła", "Złota", "Słoneczna", "Kwiatowa", "Wesoła", "Cicha", "Ogrodowa", "Wiosenna", "Spacerowa", "Sportowa", "Parkowa", "Rybacka", "Leśna", "Polna", "Łąkowa", "Rzeczna", "Jeziorna", "Morska", "Portowa", "Kolejowa", "Lotnicza", "Autobusowa", "Tramwajowa", "Dworcowa", "Fabryczna", "Przemysłowa"];
        
        const miejscowosciByGmina = {
            "Miasto Giżycko": ["Giżycko"],
            "Gmina Banie Mazurskie": ["Banie Mazurskie", "Gryżewo", "Jagiele", "Jagoczany", "Klewiny", "Kruki", "Lisy", "LIsiki", "Miczuły", "Mieduniszki Wielkie", "Mieczniki", "Rapa", "Rogale", "Rogalki", "Stary Żabin", "Żabin", "Żabinek", "Żabin Rybacki", "Zapały"],
            "Gmina Budry": ["Budry", "Budzewo", "Brzozówko", "Dąbrówka", "Droglewo", "Góry", "Grądy Węgorzewskie", "Ołownik", "Olszewo Węgorzewskie", "Więcki", "Zabrost Wielki"],
            "Gmina Giżycko": ["Antonowo", "Bogacko", "Bogaczewo", "Bystry", "Doba", "Gajewo", "Grajwo", "Guty", "Kamionki", "Kąp", "Kozin", "Kożuchy Małe", "Kożuchy Wielkie", "Kruklin", "Pieczonki", "Pierkunowo", "Piękna Góra", "Róg Pierkunowski", "Sołdany", "Spytkowo", "Sterławki Małe", "Sulimy", "Szczybały Giżyckie", "Świdry", "Upałty", "Upałty Małe", "Wilkaski", "Wilkasy", "Wronka", "Wrony"],
            "Gmina Kruklanki": ["Brożówka", "Diabla Góra", "Grądy Kruklaneckie", "Jeziorowskie", "Jurkowo", "Jurkówko", "Kamienna Struga", "Kruklanki", "Lipowo", "Łękuk Wielki", "Możdżany", "Wolisko", "Żabinka", "Żywki"],
            "Gmina Miłki": ["Miłki", "Bogaczewo", "Gawliki", "Jagodne Małe", "Jagodne Wielkie", "Jedrusy", "Kleszczewo", "Kozin", "Lisewo, Marcinowa Wola", "Paprotki", "Przykop", "Ruda", "Rydzewo", "Staświny", "Wyszowate"],
            "Miasto i Gmina Orzysz": ["Orzysz", "Drozdowo", "Dziubiele", "Dziubiele Małe", "Gaudynki", "Gorzekały", "Góra", "Grądy", "Grądy Podmiejskie", "Grzegorze", "Kamieńskie", "Klusy", "Mikosze", "Mikosze-Osada", "Nowa Wieś", "Nowe Guty", "Odoje", "Ogródek", "Okartowo", "Okartowo-Przystanek", "Okartowo-Tartak", "Osiki", "Pianki", "Rostki Skomackie", "Rzęśniki", "Strzelniki", "Sumki", "Szwejkówko", "Tuchlin", "Ublik", "Wężewo", "Wierzbiny"],
            "Gmina Pozezdrze": ["Pozezdrze", "Dziaduszyn", "Harsz", "Jakunówko", "Krzywińskie", "Kuty", "Pieczarki", "Piłaki Wielkie", "Przerwanki", "Przytuły", "Radziszewo", "Stręgielek", "Wyłudy"],
            "Miasto i Gmina Ryn": ["Ryn", "Bachorza", "Canki", "Dzikowizna", "Głąbowo", "Grzybowo", "Jeziorko", "Knis", "Kronowo", "Krzyżany", "Ławki", "Mioduńskie", "Monetki", "Orło", "Prażmowo", "Rybical", "Ryński Dwór", "Ryńskie Pole", "Siejkowo", "Skop", "Słabowo", "Stara Rudówka", "Sterławki Wielkie", "Szymonka", "Tros", "Wejdyki", "Zielony Lasek"],
            "Gmina Srokowo": ["Srokowo", "Bajory Małe", "Bajory Wielkie", "Jankowice", "Jegławki", "Kaczory", "Kosakowo", "Leśniewo", "Leśny Rów", "Łęknica", "Nowa Różanka", "Pieczarki", "Podlaski", "Różanka", "Silec", "Siwa Dziura", "Stare Różanki", "Wilkowo", "Wólka Węgorzewska", "Węgorzewo"]
        };

        // Nowy obiekt mapujący miejscowości na kody pocztowe
        const zipCodesByCity = {
            "Banie Mazurskie": "19-520",
            "Gryżewo": "19-520",
            "Jagiele": "19-520",
            "Jagoczany": "19-520",
            "Klewiny": "19-520",
            "Kruki": "19-520",
            "Lisy": "19-520",
            "LIsiki": "19-520",
            "Miczuły": "19-520",
            "Mieduniszki Wielkie": "19-520",
            "Mieczniki": "19-520",
            "Rapa": "19-520",
            "Rogale": "19-520",
            "Rogalki": "19-520",
            "Stary Żabin": "19-520",
            "Żabin": "19-520",
            "Żabinek": "19-520",
            "Żabin Rybacki": "19-520",
            "Zapały": "19-520",
            "Budry": "11-600",
            "Budzewo": "11-600",
            "Brzozówko": "11-600",
            "Dąbrówka": "11-600",
            "Droglewo": "11-600",
            "Góry": "11-600",
            "Grądy Węgorzewskie": "11-600",
            "Ołownik": "11-600",
            "Olszewo Węgorzewskie": "11-600",
            "Więcki": "11-600",
            "Zabrost Wielki": "11-600",
            "Antonowo": "11-500",
            "Bogacko": "11-500",
            "Bogaczewo": "11-500",
            "Bystry": "11-500",
            "Doba": "11-500",
            "Gajewo": "11-500",
            "Grajwo": "11-500",
            "Guty": "11-500",
            "Kamionki": "11-500",
            "Kąp": "11-500",
            "Kozin": "11-500",
            "Kożuchy Małe": "11-500",
            "Kożuchy Wielkie": "11-500",
            "Kruklin": "11-500",
            "Pieczonki": "11-500",
            "Pierkunowo": "11-500",
            "Piękna Góra": "11-500",
            "Róg Pierkunowski": "11-500",
            "Sołdany": "11-500",
            "Spytkowo": "11-500",
            "Sterławki Małe": "11-500",
            "Sulimy": "11-500",
            "Szczybały Giżyckie": "11-500",
            "Świdry": "11-500",
            "Upałty": "11-500",
            "Upałty Małe": "11-500",
            "Wilkaski": "11-500",
            "Wilkasy": "11-500",
            "Wronka": "11-500",
            "Wrony": "11-500",
            "Giżycko": "11-500",
            "Brożówka": "11-612",
            "Diabla Góra": "11-612",
            "Grądy Kruklaneckie": "11-612",
            "Jeziorowskie": "11-612",
            "Jurkowo": "11-612",
            "Jurkówko": "11-612",
            "Kamienna Struga": "11-612",
            "Kruklanki": "11-612",
            "Lipowo": "11-612",
            "Łękuk Wielki": "11-612",
            "Możdżany": "11-612",
            "Wolisko": "11-612",
            "Żabinka": "11-612",
            "Żywki": "11-612",
            "Miłki": "11-513",
            "Bogaczewo": "11-513",
            "Gawliki": "11-513",
            "Jagodne Małe": "11-513",
            "Jagodne Wielkie": "11-513",
            "Jedrusy": "11-513",
            "Kleszczewo": "11-513",
            "Lisewo, Marcinowa Wola": "11-513",
            "Paprotki": "11-513",
            "Przykop": "11-513",
            "Ruda": "11-513",
            "Rydzewo": "11-513",
            "Staświny": "11-513",
            "Wyszowate": "11-513",
            "Orzysz": "12-250",
            "Drozdowo": "12-250",
            "Dziubiele": "12-250",
            "Dziubiele Małe": "12-250",
            "Gaudynki": "12-250",
            "Gorzekały": "12-250",
            "Góra": "12-250",
            "Grądy": "12-250",
            "Grądy Podmiejskie": "12-250",
            "Grzegorze": "12-250",
            "Kamieńskie": "12-250",
            "Klusy": "12-250",
            "Mikosze": "12-250",
            "Mikosze-Osada": "12-250",
            "Nowa Wieś": "12-250",
            "Nowe Guty": "12-250",
            "Odoje": "12-250",
            "Ogródek": "12-250",
            "Okartowo": "12-250",
            "Okartowo-Przystanek": "12-250",
            "Okartowo-Tartak": "12-250",
            "Osiki": "12-250",
            "Pianki": "12-250",
            "Rostki Skomackie": "12-250",
            "Rzęśniki": "12-250",
            "Strzelniki": "12-250",
            "Sumki": "12-250",
            "Szwejkówko": "12-250",
            "Tuchlin": "12-250",
            "Ublik": "12-250",
            "Wężewo": "12-250",
            "Wierzbiny": "12-250",
            "Pozezdrze": "11-600",
            "Dziaduszyn": "11-600",
            "Harsz": "11-600",
            "Jakunówko": "11-600",
            "Krzywińskie": "11-600",
            "Kuty": "11-600",
            "Pieczarki": "11-600",
            "Piłaki Wielkie": "11-600",
            "Przerwanki": "11-600",
            "Przytuły": "11-600",
            "Radziszewo": "11-600",
            "Stręgielek": "11-600",
            "Wyłudy": "11-600",
            "Ryn": "11-520",
            "Bachorza": "11-520",
            "Canki": "11-520",
            "Dzikowizna": "11-520",
            "Głąbowo": "11-520",
            "Grzybowo": "11-520",
            "Jeziorko": "11-520",
            "Knis": "11-520",
            "Kronowo": "11-520",
            "Krzyżany": "11-520",
            "Ławki": "11-520",
            "Mioduńskie": "11-520",
            "Monetki": "11-520",
            "Orło": "11-520",
            "Prażmowo": "11-520",
            "Rybical": "11-520",
            "Ryński Dwór": "11-520",
            "Ryńskie Pole": "11-520",
            "Siejkowo": "11-520",
            "Skop": "11-520",
            "Słabowo": "11-520",
            "Stara Rudówka": "11-520",
            "Sterławki Wielkie": "11-520",
            "Szymonka": "11-520",
            "Tros": "11-520",
            "Wejdyki": "11-520",
            "Zielony Lasek": "11-520",
            "Srokowo": "11-420",
            "Bajory Małe": "11-420",
            "Bajory Wielkie": "11-420",
            "Jankowice": "11-420",
            "Jegławki": "11-420",
            "Kaczory": "11-420",
            "Kosakowo": "11-420",
            "Leśniewo": "11-420",
            "Leśny Rów": "11-420",
            "Łęknica": "11-420",
            "Nowa Różanka": "11-420",
            "Pieczarki": "11-420",
            "Podlaski": "11-420",
            "Różanka": "11-420",
            "Silec": "11-420",
            "Siwa Dziura": "11-420",
            "Stare Różanki": "11-420",
            "Wilkowo": "11-420",
            "Wólka Węgorzewska": "11-420",
            "Węgorzewo": "11-600",
            "Wydminy": "11-510"
        };

        const allParticipants = [
            { id: '1', name: 'Daria Łucaś', role: 'Inspektor ds. kontroli i windykacji' },
            { id: '2', name: 'Ewelina Bujniak', role: 'Inspektor ds. kontroli i windykacji' },
            { id: '3', name: 'Krzysztof Balcerzak', role: 'Podinspektor ds. kontroli i windykacji' },
            { id: '4', name: 'Adam Sznip', role: 'Inspektor ds. kontroli i windykacji' }
        ];

        // Zaktualizowany obiekt z notatkami, z usuniętymi numerami porządkowymi
        const notes = {
            "Brak dostępu": [
                "Na nieruchomości nikogo nie zastano.",
                "Nieruchomość ogrodzona, brak możliwości wejścia na posesję.",
                "Brama zamknięta na kłódkę, nikt nie otwiera.",
                "Brak udostępnienia pojemników i dostępu do terenu kontroli.",
                "Pomimo wielokrotnego dzwonienia, nikt nie otworzył drzwi.",
                "Nieruchomość niezamieszkała/opuszczona.",
                "Brak kontaktu z właścicielem/użytkownikiem nieruchomości.",
                "Pod wskazanym adresem znajduje się pustostan."
            ],
            "Brak segregacji": [
                "Brak segregacji odpadów komunalnych.",
                "Stwierdzono mieszanie frakcji odpadów w pojemniku na odpady zmieszane.",
                "Odpady BIO są zmieszane z innymi frakcjami.",
                "W pojemniku na odpady zmieszane znajdują się odpady segregowane (np. szkło, papier, plastik).",
                "W worku na szkło stwierdzono inne frakcje odpadów.",
                "W workach na plastik znajdują się inne frakcje odpadów.",
                "Nieruchomość niewyposażona w worki do segregacji odpadów."
            ],
            "Infrastruktura": [
                "Brak pojemników do zbierania odpadów komunalnych.",
                "Pojemniki na odpady są uszkodzone, brak pokryw.",
                "Odpady znajdują się poza pojemnikami, tworząc dzikie wysypisko.",
                "Pojemniki nie są widoczne/dostępne dla służb odbioru.",
                "Stwierdzono przepełnienie pojemników na odpady zmieszane.",
                "Stan techniczny pojemników nie spełnia wymogów.",
                "Brak pojemników na poszczególne frakcje segregowane.",
		"Brak dojazdu dorogą publiczną do nieruchomości."
            ],
            "Brak umowy": [
                "Właściciel/użytkownik nieruchomości nie posiada aktualnej umowy na odbiór odpadów.",
                "Właściciel/użytkownik nieruchomości nie złożył deklaracji.",
                "Podpisana deklaracja nie odzwierciedla stanu faktycznego.",
		"Na nieruchomości zamieszkuje większa ilość osób niż zadeklarowano.",
		"Ilość odpadów powstających na nieruchomości wskazuje na zamieszkiwanie większej liczby osób niż zadeklarowano.",
		"Ilość pojemników/częstowtliwość odbiorów nie jest dostosowana do ilości powstających na nieruchomości odpadów."
            ]
        };

        let controls = [];
        let currentEditingControl = null;

        document.addEventListener('DOMContentLoaded', () => {
            const controlsList = document.getElementById('controls-list');
            const addControlBtn = document.getElementById('add-control-btn');
            const controlModal = document.getElementById('control-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const controlForm = document.getElementById('control-form');
            const modalTitle = document.getElementById('modal-title');
            const deleteControlBtn = document.getElementById('delete-control-btn');
            const generateProtocolBtn = document.getElementById('generate-protocol-btn');
            const protocolModal = document.getElementById('protocol-modal');
            const closeProtocolModalBtn = document.getElementById('close-protocol-modal-btn');
            const protocolForm = document.getElementById('protocol-form');
            const messageBox = document.getElementById('message-box');
            const saveProtocolBtn = document.getElementById('save-protocol-btn');

            const mainListView = document.getElementById('main-list-view');
            const routeListView = document.getElementById('route-list-view');
            const filterAddressInput = document.getElementById('filter-address');
            const filterTypeSelect = document.getElementById('filter-type');
            const generateRouteBtn = document.getElementById('generate-route-btn');
            const routeDateInput = document.getElementById('route-date');
            const showMainBtn = document.getElementById('show-main-btn');
            const routeItemsList = document.getElementById('route-items');
            const routeDateDisplay = document.getElementById('route-date-display');
            const downloadRouteBtn = document.getElementById('download-route-btn');
            const pdfContentContainer = document.getElementById('pdf-content-container');
            const clearAllBtn = document.getElementById('clear-all-btn');

            const participantsContainer = document.getElementById('participants-container');
            const controlStreetInput = document.getElementById('control-street');
            const controlCityInput = document.getElementById('control-city');
            const controlZipInput = document.getElementById('control-zip');
            
            const noteCategoriesContainer = document.getElementById('note-categories');
            const noteListContainer = document.getElementById('note-list');
            const protocolFindingsTextarea = document.getElementById('protocol-findings');
            
            // ELEMENTY ZWIĄZANE Z ZDJĘCIAMI
            const protocolPhotosInput = document.getElementById('protocol-photos-input');
            const photosPreviewContainer = document.getElementById('photos-preview-container');


            loadData();
            
            const unionSignaturePad = document.getElementById('union-signature-pad');
            const unionSignatureCtx = unionSignaturePad.getContext('2d');
            const partiesSignaturePad = document.getElementById('parties-signature-pad');
            const partiesSignatureCtx = partiesSignaturePad.getContext('2d');

            function initializeSignaturePad(canvas, context) {
                let isDrawing = false;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                context.strokeStyle = '#000';
                context.lineWidth = 2;
                context.lineCap = 'round';
                context.lineJoin = 'round';
                
                const dpr = window.devicePixelRatio || 1;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                context.scale(dpr, dpr);
                context.lineWidth = 2;

                const getEventPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    return {
                        x: (e.clientX || e.touches[0].clientX) - rect.left,
                        y: (e.clientY || e.touches[0].clientY) - rect.top
                    };
                };

                const startDrawing = (e) => {
                    isDrawing = true;
                    context.beginPath();
                    const pos = getEventPos(e);
                    context.moveTo(pos.x, pos.y);
                };

                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const pos = getEventPos(e);
                    context.lineTo(pos.x, pos.y);
                    context.stroke();
                };

                const stopDrawing = () => {
                    isDrawing = false;
                };

                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                canvas.addEventListener('touchstart', startDrawing, { passive: false });
                canvas.addEventListener('touchmove', draw, { passive: false });
                canvas.addEventListener('touchend', stopDrawing);
                canvas.addEventListener('touchcancel', stopDrawing);
            }
            
            function reinitializeSignaturePads() {
                 setTimeout(() => {
                    initializeSignaturePad(unionSignaturePad, unionSignatureCtx);
                    initializeSignaturePad(partiesSignaturePad, partiesSignatureCtx);
                }, 100);
            }

            function clearSignaturePad(canvas, context) {
                context.clearRect(0, 0, canvas.width, canvas.height);
            }

            document.getElementById('clear-union-signature').addEventListener('click', () => clearSignaturePad(unionSignaturePad, unionSignatureCtx));
            document.getElementById('clear-parties-signature').addEventListener('click', () => clearSignaturePad(partiesSignaturePad, partiesSignatureCtx));

            function loadSignature(canvas, dataURL) {
                const img = new Image();
                img.onload = () => {
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = dataURL;
            }

            function showMessage(message, type) {
                messageBox.textContent = message;
                messageBox.className = 'fixed bottom-8 right-8 p-4 rounded-lg text-white shadow-lg z-50 transition-opacity duration-300';
                if (type === 'success') {
                    messageBox.classList.add('bg-green-500');
                } else {
                    messageBox.classList.add('bg-red-500');
                }
                messageBox.classList.remove('hidden', 'opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    setTimeout(() => messageBox.classList.add('hidden'), 300);
                }, 3000);
            }

            function openModal(modal) {
                modal.classList.remove('invisible', 'opacity-0');
                modal.classList.add('open', 'visible', 'opacity-100');
            }

            function closeModal(modal) {
                modal.classList.remove('open', 'visible', 'opacity-100');
                modal.classList.add('invisible', 'opacity-0');
            }

            function saveData() {
                localStorage.setItem('controls', JSON.stringify(controls));
            }

            function loadData() {
                const savedControls = localStorage.getItem('controls');
                if (savedControls) {
                    controls = JSON.parse(savedControls);
                }
            }
            
            function renderControls(filteredControls = controls) {
                controlsList.innerHTML = '';
                if (filteredControls.length === 0) {
                    controlsList.innerHTML = '<p class="text-center text-gray-500">Brak kontroli do wyświetlenia.</p>';
                }
                filteredControls.forEach(control => {
                    const controlEl = document.createElement('div');
                    controlEl.className = 'bg-gray-100 rounded-lg p-4 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0';
                    controlEl.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${control.address}</p>
                            <p class="text-sm text-gray-600">${control.type.charAt(0).toUpperCase() + control.type.slice(1)} - ${control.date}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${control.id}" class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors duration-300">Edytuj</button>
                            <button data-id="${control.id}" class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors duration-300">Usuń</button>
                        </div>
                    `;
                    controlsList.appendChild(controlEl);
                });

                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        currentEditingControl = controls.find(c => c.id === id);
                        if (currentEditingControl) {
                            modalTitle.textContent = 'Edytuj kontrolę';
                            document.getElementById('control-street').value = currentEditingControl.street;
                            document.getElementById('control-house-number').value = currentEditingControl.houseNumber;
                            document.getElementById('control-city').value = currentEditingControl.city;
                            document.getElementById('control-zip').value = currentEditingControl.zip;
                            document.getElementById('control-type').value = currentEditingControl.type;
                            document.getElementById('control-date').value = currentEditingControl.date;
                            deleteControlBtn.classList.remove('hidden');
                            generateProtocolBtn.classList.remove('hidden');
                            updateParticipantsCheckboxes(currentEditingControl.participants);
                            openModal(controlModal);
                        }
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        controls = controls.filter(c => c.id !== id);
                        saveData();
                        renderControls();
                        showMessage('Kontrola usunięta pomyślnie!', 'success');
                    });
                });
            }

            function generateParticipantsCheckboxes() {
                participantsContainer.innerHTML = '';
                allParticipants.forEach(p => {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center space-x-2';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="participant-${p.id}" name="participant" value="${p.id}" data-name="${p.name}" data-role="${p.role}" class="participant-checkbox">
                        <label for="participant-${p.id}" class="text-sm text-gray-700">${p.name} (${p.role})</label>
                    `;
                    participantsContainer.appendChild(checkboxDiv);
                });
            }

            function updateParticipantsCheckboxes(selectedParticipants) {
                generateParticipantsCheckboxes();
                selectedParticipants.forEach(p => {
                    const checkbox = document.getElementById(`participant-${p.id}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }

            generateParticipantsCheckboxes();

            function setupAutocomplete(input, list) {
                input.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const datalist = document.createElement('datalist');
                    datalist.id = `${input.id}-datalist`;
                    const matches = list.filter(item => item.toLowerCase().includes(query)).slice(0, 10);
                    matches.forEach(match => {
                        const option = document.createElement('option');
                        option.value = match;
                        datalist.appendChild(option);
                    });
                    const existingDatalist = document.getElementById(`${input.id}-datalist`);
                    if (existingDatalist) {
                        existingDatalist.remove();
                    }
                    input.setAttribute('list', `${input.id}-datalist`);
                    input.after(datalist);
                });
            }

            function setupCityAutocomplete() {
                const allMiejscowosci = Object.values(miejscowosciByGmina).flat();
                setupAutocomplete(controlCityInput, allMiejscowosci);

                controlCityInput.addEventListener('change', (e) => {
                    const city = e.target.value;
                    if (zipCodesByCity[city]) {
                        controlZipInput.value = zipCodesByCity[city];
                    }
                });
            }
            
            setupAutocomplete(controlStreetInput, ulice);
            setupCityAutocomplete();

            function generateRoute(date) {
                const dailyControls = controls.filter(c => c.date === date).sort((a, b) => a.address.localeCompare(b.address));
                routeDateDisplay.textContent = date;
                routeItemsList.innerHTML = '';
                if (dailyControls.length === 0) {
                    routeItemsList.innerHTML = '<li class="text-gray-500">Brak kontroli zaplanowanych na ten dzień.</li>';
                    downloadRouteBtn.classList.add('hidden');
                } else {
                    dailyControls.forEach((control, index) => {
                        const li = document.createElement('li');
                        li.className = 'bg-white p-3 rounded-lg shadow-sm flex items-center justify-between';
                        li.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="bg-blue-200 text-blue-800 font-bold text-sm px-2 py-1 rounded-full">${index + 1}</span>
                                <div>
                                    <p class="font-semibold">${control.address}</p>
                                    <p class="text-sm text-gray-500">Typ: ${control.type.charAt(0).toUpperCase() + control.type.slice(1)}</p>
                                </div>
                            </div>
                        `;
                        routeItemsList.appendChild(li);
                    });
                    downloadRouteBtn.classList.remove('hidden');
                }
                mainListView.classList.add('hidden');
                routeListView.classList.remove('hidden');
            }

            controlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const street = document.getElementById('control-street').value;
                const houseNumber = document.getElementById('control-house-number').value;
                const city = document.getElementById('control-city').value;
                const zip = document.getElementById('control-zip').value;
                const type = document.getElementById('control-type').value;
                const date = document.getElementById('control-date').value;
                const selectedParticipants = Array.from(document.querySelectorAll('input[name="participant"]:checked')).map(cb => ({
                    id: cb.value,
                    name: cb.dataset.name,
                    role: cb.dataset.role
                }));

                const newControl = {
                    street,
                    houseNumber,
                    city,
                    zip,
                    type,
                    date,
                    participants: selectedParticipants,
                    address: `${street} ${houseNumber}, ${city} ${zip}`
                };

                if (currentEditingControl) {
                    const index = controls.findIndex(c => c.id === currentEditingControl.id);
                    if (index !== -1) {
                        newControl.id = currentEditingControl.id;
                        if (currentEditingControl.protocolData) {
                            newControl.protocolData = currentEditingControl.protocolData;
                        }
                        controls[index] = newControl;
                        showMessage('Kontrola zaktualizowana pomyślnie!', 'success');
                    }
                } else {
                    newControl.id = 'control-' + Date.now();
                    controls.push(newControl);
                    showMessage('Nowa kontrola dodana pomyślnie!', 'success');
                }

                saveData();
                renderControls();
                closeModal(controlModal);
            });

            addControlBtn.addEventListener('click', () => {
                currentEditingControl = null;
                modalTitle.textContent = 'Dodaj nową kontrolę';
                controlForm.reset();
                deleteControlBtn.classList.add('hidden');
                generateProtocolBtn.classList.add('hidden');
                generateParticipantsCheckboxes();
                openModal(controlModal);
            });

            closeModalBtn.addEventListener('click', () => {
                closeModal(controlModal);
            });

            deleteControlBtn.addEventListener('click', () => {
                if (currentEditingControl) {
                    controls = controls.filter(c => c.id !== currentEditingControl.id);
                    saveData();
                    renderControls();
                    closeModal(controlModal);
                    showMessage('Kontrola usunięta pomyślnie!', 'success');
                }
            });

            function renderNoteCategories() {
                noteCategoriesContainer.innerHTML = '';
                const categories = Object.keys(notes);
                categories.forEach(category => {
                    const button = document.createElement('button');
                    button.type = 'button'; 
                    button.textContent = category;
                    button.className = 'bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors duration-300';
                    button.dataset.category = category;
                    noteCategoriesContainer.appendChild(button);
                });
            }

            function renderNotes(category) {
                noteListContainer.innerHTML = '';
                if (notes[category]) {
                    notes[category].forEach(note => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = note;
                        button.className = 'bg-blue-200 hover:bg-blue-300 text-blue-800 text-sm py-2 px-4 rounded-lg transition-colors duration-300 text-left';
                        button.dataset.note = note;
                        noteListContainer.appendChild(button);
                    });
                }
            }
            
            // FUNKCJA DLA ZDJĘĆ
            function renderPhotosPreview(photos) {
                photosPreviewContainer.innerHTML = '';
                if (!photos || photos.length === 0) {
                    photosPreviewContainer.innerHTML = '<p class="text-sm text-gray-500">Brak dodanych zdjęć.</p>';
                    return;
                }
                photos.forEach((photoDataUrl, index) => {
                    const div = document.createElement('div');
                    div.className = 'relative w-24 h-24 shadow-md';
                    div.innerHTML = `
                        <img src="${photoDataUrl}" alt="Zdjęcie ${index + 1}" class="w-full h-full object-cover rounded-lg border border-gray-300">
                        <button type="button" data-index="${index}" class="remove-photo-btn absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold hover:bg-red-700 transition-colors duration-300">&times;</button>
                    `;
                    photosPreviewContainer.appendChild(div);
                });
            }
            
            // FUNKCJA USUWANIA ZDJĘĆ
            photosPreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-photo-btn') && currentEditingControl && currentEditingControl.protocolData) {
                    const index = parseInt(e.target.dataset.index);
                    currentEditingControl.protocolData.photos.splice(index, 1);
                    renderPhotosPreview(currentEditingControl.protocolData.photos);
                    saveData();
                    showMessage('Zdjęcie usunięto.', 'success');
                }
            });

            // FUNKCJA KONWERSJI PLIKÓW NA BASE64
            function fileToDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // OBSŁUGA DODAWANIA ZDJĘĆ
            protocolPhotosInput.addEventListener('change', async (e) => {
                if (!currentEditingControl) return;

                const files = Array.from(e.target.files);
                if (!currentEditingControl.protocolData) {
                    currentEditingControl.protocolData = {};
                }
                if (!currentEditingControl.protocolData.photos) {
                    currentEditingControl.protocolData.photos = [];
                }

                try {
                    const dataUrls = await Promise.all(files.map(fileToDataURL));
                    currentEditingControl.protocolData.photos.push(...dataUrls);
                    renderPhotosPreview(currentEditingControl.protocolData.photos);
                    saveData();
                    showMessage(`Dodano ${files.length} zdjęć!`, 'success');
                } catch (error) {
                    showMessage('Błąd podczas wczytywania zdjęć.', 'error');
                    console.error('Błąd wczytywania zdjęć:', error);
                } finally {
                    protocolPhotosInput.value = ''; // Reset, aby można było dodać te same pliki
                }
            });
            // KONIEC FUNKCJI DLA ZDJĘĆ

            noteCategoriesContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const category = e.target.dataset.category;
                    renderNotes(category);
                }
            });

            noteListContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const note = e.target.dataset.note;
                    const findings = protocolFindingsTextarea.value.trim();
                    if (findings === '') {
                        protocolFindingsTextarea.value = note;
                    } else {
                        protocolFindingsTextarea.value = findings + '\n' + note;
                    }
                }
            });

            generateProtocolBtn.addEventListener('click', () => {
                if (!currentEditingControl) {
                    showMessage('Najpierw wybierz kontrolę do wygenerowania protokołu.', 'error');
                    return;
                }
                
                reinitializeSignaturePads();
                renderNoteCategories();
                noteListContainer.innerHTML = '';
                
                const unionReps = currentEditingControl.participants.map(p => `${p.name} - ${p.role}`).join('\n');
                
                document.getElementById('protocol-date').value = currentEditingControl.date;
                document.getElementById('protocol-union-reps').value = unionReps;
                document.getElementById('protocol-case').value = `nieruchomości położonej pod adresem: ${currentEditingControl.address}`;
                
                if (currentEditingControl.protocolData) {
                    const data = currentEditingControl.protocolData;
                    document.getElementById('protocol-date').value = data.date || '';
                    document.getElementById('protocol-case').value = data.case || '';
                    // Zachowanie danych, jeśli zostały zmienione ręcznie, ale użycie zaktualizowanej listy jako domyślnej
                    document.getElementById('protocol-union-reps').value = data.unionReps || unionReps;
                    document.getElementById('protocol-admin-reps').value = data.adminReps || '';
                    document.getElementById('protocol-parties').value = data.parties || '';
                    document.getElementById('protocol-witnesses').value = data.witnesses || '';
                    document.getElementById('protocol-findings').value = data.findings || '';
                    
                    clearSignaturePad(unionSignaturePad, unionSignatureCtx);
                    clearSignaturePad(partiesSignaturePad, partiesSignatureCtx);

                    if (data.unionSignature) {
                        loadSignature(unionSignaturePad, data.unionSignature);
                    }
                    if (data.partiesSignature) {
                        loadSignature(partiesSignaturePad, data.partiesSignature);
                    }
                    // Wczytanie zdjęć
                    renderPhotosPreview(data.photos || []);

                } else {
                    protocolForm.reset();
                    clearSignaturePad(unionSignaturePad, unionSignatureCtx);
                    clearSignaturePad(partiesSignaturePad, partiesSignatureCtx);
                    document.getElementById('protocol-union-reps').value = unionReps;
                    document.getElementById('protocol-case').value = `nieruchomości położonej pod adresem: ${currentEditingControl.address}`;
                    // Wyczyść podgląd zdjęć
                    renderPhotosPreview([]);
                }

                openModal(protocolModal);
            });

            closeProtocolModalBtn.addEventListener('click', () => {
                closeModal(protocolModal);
            });

            saveProtocolBtn.addEventListener('click', () => {
                if (!currentEditingControl) {
                    showMessage('Brak wybranej kontroli do zapisania protokołu!', 'error');
                    return;
                }
                
                const photosToSave = (currentEditingControl.protocolData && currentEditingControl.protocolData.photos) ? currentEditingControl.protocolData.photos : [];

                const protocolData = {
                    date: document.getElementById('protocol-date').value,
                    case: document.getElementById('protocol-case').value,
                    unionReps: document.getElementById('protocol-union-reps').value,
                    adminReps: document.getElementById('protocol-admin-reps').value,
                    parties: document.getElementById('protocol-parties').value,
                    witnesses: document.getElementById('protocol-witnesses').value,
                    findings: document.getElementById('protocol-findings').value,
                    unionSignature: unionSignaturePad.toDataURL('image/png'),
                    partiesSignature: partiesSignaturePad.toDataURL('image/png'),
                    photos: photosToSave // Zapisz zdjęcia
                };

                const index = controls.findIndex(c => c.id === currentEditingControl.id);
                if (index !== -1) {
                    controls[index].protocolData = protocolData;
                    saveData();
                    showMessage('Dane protokołu zapisano pomyślnie!', 'success');
                }
            });

            document.getElementById('finalize-protocol-btn').addEventListener('click', async () => {
                const protocolDate = document.getElementById('protocol-date').value;
                const protocolCase = document.getElementById('protocol-case').value;
                const protocolUnionReps = document.getElementById('protocol-union-reps').value.replace(/\n/g, '<br>'); // Zastąpienie nowych linii na <br> dla HTML
                const protocolAdminReps = document.getElementById('protocol-admin-reps').value;
                const protocolParties = document.getElementById('protocol-parties').value;
                const protocolWitnesses = document.getElementById('protocol-witnesses').value;
                const protocolFindings = document.getElementById('protocol-findings').value;
                const unionSignatureData = unionSignaturePad.toDataURL('image/png');
                const partiesSignatureData = partiesSignaturePad.toDataURL('image/png');
                
                if (!protocolDate || !protocolCase || !protocolFindings) {
                    showMessage('Wypełnij wszystkie wymagane pola!', 'error');
                    return;
                }
                
                // POBRANIE ZDJĘĆ
                const photos = (currentEditingControl.protocolData && currentEditingControl.protocolData.photos) ? currentEditingControl.protocolData.photos : [];
                let photosHtml = '';
                if (photos.length > 0) {
                    photosHtml = '<h3 class="text-xl font-bold mt-8 mb-4 break-before-page">Załączone Zdjęcia</h3><div style="display: flex; flex-wrap: wrap; gap: 20px; break-inside: avoid;">';
                    photos.forEach((photoDataUrl, index) => {
                        // Użycie znacznika img i ograniczenie rozmiaru dla PDF
                        photosHtml += `<div style="width: 350px; border: 1px solid #ccc; padding: 5px; text-align: center; margin-bottom: 20px;">
                                            <img src="${photoDataUrl}" style="width: 100%; height: auto; display: block;">
                                            <p style="margin-top: 5px; font-size: 10px;">Zdjęcie nr ${index + 1}</p>
                                        </div>`;
                    });
                    photosHtml += '</div>';
                }
                // KONIEC POBRANIA ZDJĘĆ

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const container = pdfContentContainer;

                container.innerHTML = `
                    <div class="p-6">
                        <h1 class="text-xl font-bold text-center mb-4">ZAŁĄCZNIK NR 2 DO PROCEDURY</h1>
                        <h2 class="text-2xl font-bold text-center mb-6">PROTOKÓŁ OGLĘDZIN</h2>
                        <p class="mb-2">W dniu <span class="font-semibold">${protocolDate}</span> dokonano oględzin w sprawie: <span class="font-semibold">${protocolCase}</span></p>
                        <p class="mt-6 mb-2"><strong>Obecni:</strong></p>
                        <p class="mb-2"><strong>Przedstawiciele Związku:</strong><br>${protocolUnionReps}</p>
                        <p class="mb-2"><strong>Inni przedstawiciele organów administracji:</strong> ${protocolAdminReps}</p>
                        <p class="mb-2"><strong>Strony i ich pełnomocnicy:</strong> ${protocolParties}</p>
                        <p class="mb-2"><strong>Świadkowie:</strong> ${protocolWitnesses}</p>
                        <p class="mt-6 mb-2"><strong>Ustalono co następuje:</strong></p>
                        <p class="mb-4">${protocolFindings.replace(/\n/g, '<br>')}</p>
                        <p class="mt-6">Protokół odczytano wszystkim obecnym.</p>
                        
                        <div class="mt-12 flex justify-between items-center">
                            <div class="text-center w-1/2">
                                <p>(podpis stron i osób obecnych)</p>
                                <img src="${partiesSignatureData}" style="width: 250px; height: 120px; margin: 10px auto; border: 1px solid #000;">
                                <p>.......................................</p>
                            </div>
                            <div class="text-center w-1/2">
                                <p>(podpis przedstawicieli Związku)</p>
                                <img src="${unionSignatureData}" style="width: 250px; height: 120px; margin: 10px auto; border: 1px solid #000;">
                                <p>.......................................</p>
                            </div>
                        </div>
                        
                        ${photosHtml}
                    </div>
                `;

                try {
                    const canvas = await html2canvas(container, {
                        scale: 2,
                        useCORS: true,
                        width: container.offsetWidth,
                        height: container.offsetHeight
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const pageHeight = pdf.internal.pageSize.height;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    const fileName = currentEditingControl.address.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                    pdf.save(`protokol_ogledzin_${fileName}.pdf`);
                    showMessage('Protokół pobrano pomyślnie!', 'success');
                    closeModal(protocolModal);
                } catch (error) {
                    console.error("Błąd podczas generowania PDF:", error);
                    showMessage('Wystąpił błąd podczas generowania PDF.', 'error');
                }
            });

            downloadRouteBtn.addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const routeElement = document.getElementById('route-content');

                try {
                    const canvas = await html2canvas(routeElement, {
                        scale: 2,
                        useCORS: true
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 190;
                    const pageHeight = pdf.internal.pageSize.height;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }

                    pdf.save(`trasowka_${routeDateInput.value}.pdf`);
                    showMessage('Trasówkę pobrano pomyślnie!', 'success');
                } catch (error) {
                    console.error("Błąd podczas generowania PDF:", error);
                    showMessage('Wystąpił błąd podczas generowania PDF.', 'error');
                }
            });

            filterAddressInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = controls.filter(control => control.address.toLowerCase().includes(query));
                renderControls(filtered);
            });

            filterTypeSelect.addEventListener('change', (e) => {
                const type = e.target.value;
                const filtered = type ? controls.filter(control => control.type === type) : controls;
                renderControls(filtered);
            });

            generateRouteBtn.addEventListener('click', () => {
                const date = routeDateInput.value;
                if (date) {
                    generateRoute(date);
                } else {
                    showMessage('Proszę wybrać datę, aby wygenerować trasówkę.', 'error');
                }
            });

            showMainBtn.addEventListener('click', () => {
                routeListView.classList.add('hidden');
                mainListView.classList.remove('hidden');
                renderControls();
            });

            clearAllBtn.addEventListener('click', () => {
                if (confirm('Czy na pewno chcesz usunąć WSZYSTKIE kontrole? Tej operacji nie można cofnąć.')) {
                    controls = [];
                    saveData();
                    renderControls();
                    showMessage('Wszystkie kontrole zostały usunięte!', 'success');
                }
            });

            renderControls();
        });
    </script>
</body>
</html>